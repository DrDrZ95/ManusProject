#!/usr/local/bin/bpftrace

/*
 * network_monitor.bt
 * 监控网络活动（TCP连接、数据包发送/接收）的bpftrace脚本
 * This bpftrace script monitors network activity (TCP connections, packet send/receive).
 */

BEGIN
{
    printf("Monitoring network activity... Hit Ctrl-C to end.\n");
}

kprobe:tcp_connect
{
    printf("TCP Connect: PID %d, Comm %s\n", pid, comm);
}

kprobe:tcp_sendmsg
{
    printf("TCP Send: PID %d, Comm %s, Size %d\n", pid, comm, arg2);
}

kprobe:tcp_recvmsg
{
    printf("TCP Recv: PID %d, Comm %s, Size %d\n", pid, comm, arg2);
}

kprobe:dev_queue_xmit
{
    printf("Net Xmit: PID %d, Comm %s, Len %d\n", pid, comm, arg1->len);
}

kprobe:netif_receive_skb
{
    printf("Net Recv: PID %d, Comm %s, Len %d\n", pid, comm, arg0->len);
}

END
{
    printf("Network monitoring ended.\n");
}

