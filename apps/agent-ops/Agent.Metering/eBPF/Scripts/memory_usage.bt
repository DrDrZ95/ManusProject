#!/usr/local/bin/bpftrace

/*
 * memory_usage.bt
 * 监控系统内存使用率的bpftrace脚本
 * This bpftrace script monitors system memory usage.
 */

BEGIN
{
    printf("Tracing memory usage... Hit Ctrl-C to end.\n");
}

interval:s:1
{
    $mem_total = ksym("MemTotal");
    $mem_free = ksym("MemFree");
    $buffers = ksym("Buffers");
    $cached = ksym("Cached");

    $mem_used = $mem_total - $mem_free - $buffers - $cached;

    if ($mem_total > 0) {
        $memory_usage_percent = ($mem_used * 100.0) / $mem_total;
        printf("%.2f\n", $memory_usage_percent);
    }
}

END
{
    printf("Memory usage tracing ended.\n");
}

